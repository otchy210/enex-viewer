# ワークストリーム運用ノート

これまでの Phase 1 のレーン定義・成果物は `docs/archive/phase1-workstreams.md` に保存されています。ここでは今後のフェーズでワークストリームを設計・更新するための指針のみを残します。

## 1. レーン設計の考え方

- 目的と成果物を 3〜5 個の箇条書きで明確化し、タスクと 1 対多で結び付ける。
- 各レーンに「受け入れ観点（テスト/ドキュメント/運用チェック）」を定義し、着手前に整合を取る。
- 並列実行が前提のため、境界やインターフェースは OpenAPI / TypeScript 型 / ドキュメントで固定する。

## 2. 設計フロー

1. 目的（例: API 機能拡張 / Web UX 改善 / Quality 改善）を列挙する。
2. レーンを仮置きし、各レーンの代表タスクと依存を `implementation-tasks.md` に落とし込む。
3. 実装が完了したレーンは `docs/archive/` 下へ移動し、現行ファイルは常にアクティブなレーンだけを保持する。

## 3. アーカイブ参照

- 完了済レーン履歴: `docs/archive/phase1-workstreams.md`
- タスク履歴: `docs/archive/phase1-implementation-tasks.md`

必要に応じて新規レーン表を追加し、完了したらアーカイブへ移す運用を繰り返してください。

---

## Phase 2 レーン定義

### レーン P2-A: 永続化 & アップロード基盤（T-201, T-202）
- 目的: 1GB ストリーミングアップロードと SQLite 永続化、ハッシュ重複排除を実装する。
- 主成果物:
  - `<DATA_DIR>/enex-viewer.sqlite` を操作する永続層（imports/notes/resources）
  - 1GB 対応の `POST /api/enex/parse`（busboy などでストリーム処理）
  - `POST /api/imports/hash-lookup` とハッシュユニーク制約
  - `ENEX_VIEWER_DATA` 環境変数によるデータディレクトリ切り替え
- 受け入れ観点:
  - 1GB テストファイルでアップロード→再起動後も参照可能
  - 同一ファイルを再アップロードしても既存 importId が返り、UNIQUE 制約違反が発生しない（T-208）
  - 主要 API テストが SQLite を用いた integration で通過

### レーン P2-B: クライアントハッシュ & アップロード UX（T-203）
- 目的: ファイル選択時にクライアントで SHA-256 を計算し、重複アップロードを前に回避する。
- 主成果物:
  - Web でのストリームハッシュ計算ワーカー
  - ハッシュ照会 UI（既存 import の場合は通知＆再参照ボタン表示）
  - 進捗/キャンセル UI の改善
- 受け入れ観点:
  - 大容量ファイルでも UI が固まらず、ハッシュ進捗が表示される
  - 既存 import の場合は API を呼ばずに importId が復帰できる

### レーン P2-C: 添付ファイル配信 & UI（T-204, T-205, T-206）
- 目的: 添付リソースの個別/一括ダウンロードと一覧操作の改善。
- 主成果物:
  - `GET /api/imports/:importId/notes/:noteId/resources/:resourceId`
  - 一括 zip 生成 API
  - ノート詳細の添付リスト（ファイル名・サイズ・個別DL）
  - ノート一覧のチェックボックス、全選択トグル、一括ダウンロードボタン
- 受け入れ観点:
  - API/フロント双方でダウンロードが動作し、保存ファイル名は人がわかる形式
  - チェック状態が state 管理され、複数選択→zip ダウンロードが可能
  - 自動/手動テストでリグレッションがない

### レーン P2-D: QA / ドキュメント更新（T-207）
- 目的: Phase 2 の要件に合わせて手動テスト/README/仕様を更新し、受け入れプロセスを整備する。
- 主成果物:
  - 新シナリオ（1GB アップロード、重複スキップ、添付DL、一括zip）を `manual-test-scenarios` に追加
  - README / docs INDEX から Phase 2 の機能へ導線を追加
- 受け入れ観点:
  - 手動テストテンプレートが最新 Phase の手順を反映し、結果記録が可能
  - 主要ドキュメントに Phase 2 の更新箇所が反映されている
