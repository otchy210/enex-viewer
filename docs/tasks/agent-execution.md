# エージェント実行ガイド

## 1. 目的
クラウド上の複数 Codex エージェントへ安全に並列タスク委譲するための運用ルールを定義する。

## 2. 1タスク1PR原則
- 1 エージェントは原則 1 タスク ID を担当する。
- 1 PR で複数タスクを混在させない。

## 2.1 ブランチ命名規約
- 機能ブランチ名には担当タスク ID（例: `T-003`）を必ず含める。
- ブランチ名は `codex/t-00x-<short-description>` 形式を推奨する。
- 例:
  - `codex/t-003-enex-upload-endpoint`
  - `codex/t-009-note-list-search-ui`

## 2.2 コミットメッセージ規約
- コミットメッセージ先頭には担当タスク ID を必ず付ける。
- 形式は `T-00x: <summary>` とする。
- 例:
  - `T-003: Add ENEX upload endpoint`
  - `T-013: Update OpenAPI and README`

## 3. 入力テンプレート
エージェントへ渡す指示は最低限以下を含める。
- Task ID
- 対象ファイル/ディレクトリ
- 依存タスク
- 完了条件（受け入れ条件）
- 禁止事項（スコープ外変更、破壊的変更など）

## 4. 完了判定テンプレート
- [ ] `npm run typecheck` が通る
- [ ] 影響範囲のテストが通る
- [ ] ドキュメント更新が必要なら反映済み
- [ ] 変更内容がタスク受け入れ条件を満たす
- [ ] 最終段で人間による動作テスト（手動シナリオ）を実施・記録済み

## 5. コンフリクト回避
- API と Web で担当レーンを分ける。
- 共通ファイル（`README.md`, `openapi.yaml`）は後段の Docs タスクで集約更新する。
- 同時編集が避けられない場合はタスクをさらに分割する。

## 5.1 ライブラリ選定ルール（再発明の回避）
- 実装前に、Node.js/ブラウザの標準 API と既存ライブラリで解決可能かを必ず確認する。
- 同等に解決できる場合は、自前実装より保守実績のある枯れたライブラリを優先する。
- 自前実装を選ぶ場合は、PR 説明に「既存手段を採用しなかった理由」を簡潔に記載する。

## 5.2 テスト基盤ルール
- 新規テストは既存基盤を使用する（API: Vitest + Supertest、Web: Vitest + Testing Library + jsdom）。
- テスト追加時は、workspace の標準コマンドで実行可能にする（`npm run test -w apps/api`、`npm run test -w apps/web`）。
- 新たなテストフレームワークは、明確な必要性と合意がない限り導入しない。

## 6. タスク完了時のチェック更新
- 各エージェントは、担当したワークパッケージファイル（`docs/tasks/work-packages/*.md`）内の対象タスクを、完了時に `[ ]` から `[x]` へ更新する。
- チェック更新は実装変更と同じ PR に含める。
- 担当外タスクのチェックは変更しない。

## 7. 依存切り離し運用（契約先行 + モック）
- API と Web を並列化する場合、最初に API 契約（`apps/api/openapi.yaml`）を固定する。
- Web 担当エージェントは、契約準拠のモックを使って先行実装してよい。
- API 実装完了後の統合 PR で、モックから実 API への切り替えと疎通確認を行う。
- タスク依頼文には「実 API 依存」か「契約 + モックで先行可能」かを明記する。
