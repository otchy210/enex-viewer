# ENEX Viewer Phase 2 要件定義

## 1. 目的

Phase 2 では大容量 ENEX ファイルの取り込みと、永続化・再利用性の向上、添付ファイルのダウンロード体験改善を行う。

## 2. スコープ

### 2.1 Phase 2 に含める
- ENEX アップロード上限を 1GB まで拡張
- 解析結果を SQLite ファイルに永続化し、インメモリ依存を解消
- ENEX ファイルのハッシュをキーにし、重複アップロードを判定して再パースをスキップ
- Web クライアントでファイル選択後にハッシュを計算し、既存データがあればアップロード前に通知（ボーナス）
- ノート詳細で添付ファイル名とダウンロードリンクを表示
- ノート一覧にチェックボックスを追加し、複数添付の一括ダウンロードを可能にする
- 「すべて選択」トグルで一覧のチェック操作を簡略化

### 2.2 Phase 2 で含めない
- ハッシュの衝突検知以上の重複検査（例: diff 表示）
- 複数ユーザーの認証やアクセス制御
- S3 などのリモートストレージ連携

## 3. 機能要件

- FR-201: API は 1GB までの multipart ENEX を受け付け、進捗/エラーメッセージを返す。
- FR-202: ENEX 解析後の Import データを SQLite に保存し、アプリ再起動後も参照できる。
- FR-203: アップロード時に ENEX ファイルの SHA-256 ハッシュを計算し、既存レコードがあれば importId を再利用する。
- FR-204: Web クライアントはファイル選択後にハッシュを計算し、既存 Import があればアップロードをスキップしてメッセージを表示する（ボーナス）。
- FR-205: ノート詳細で各添付リソースのファイル名とサイズ、ダウンロードリンクを提供する。
- FR-206: ノート一覧の各行にチェックボックスを追加し、選択ノートの添付リソースを zip などにまとめてダウンロードできる。
- FR-207: 「全て選択/全て解除」トグルを備え、チェック状態を一括制御する。

## 4. 非機能要件

- NFR-201: 1GB ファイルのアップロード/解析中に UI がフリーズしないよう、進捗表示とキャンセル手段を用意する。
- NFR-202: SQLite 永続化はトランザクションを利用し、クラッシュ時にデータ不整合を防ぐ。
- NFR-203: ハッシュ計算は Web/Node いずれもストリーム処理を使い、メモリ使用量を抑える。
- NFR-204: 一括ダウンロード時の zip 生成は CPU 使用を可視化し、タイムアウトを設定する。

## 5. 受け入れ条件

- 1GB テストファイルでアップロード→解析→再起動後の参照が確認できる。
- 同じファイルを再度アップロードした際にスキップ通知が表示される（サーバー側は再パースしない）。
- 添付ファイル名/ダウンロードリンクが単体/一括で動作する。
- ノート一覧チェックボックスと全選択トグルがテストケースに沿って機能する。

## 6. 参照

- Phase 1 要件: `docs/archive/phase1-requirements.md`
- Phase 2 仕様: `docs/product/phase2-spec.md`
- Phase 2 設計: `docs/design/phase2-system-design.md`
